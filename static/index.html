<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeetCode RAGåŠ©æ‰‹</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
            background-color: #f9f9f9;
        }
        .container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .chat-container {
            display: flex;
            flex-grow: 1;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            background-color: #fff;
        }
        .sidebar {
            width: 260px;
            background-color: #f0f0f0;
            padding: 20px;
            flex-shrink: 0;
        }
        .chat-area {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        .chat-messages {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .input-area {
            padding: 20px;
            border-top: 1px solid #eee;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        .message {
            max-width: 85%;
            padding: 15px;
            border-radius: 10px;
            position: relative;
            line-height: 1.6;
        }
        .user-message {
            align-self: flex-end;
            background-color: #0084ff;
            color: white;
        }
        .assistant-message {
            align-self: flex-start;
            background-color: #f0f0f0;
            color: #333;
        }
        .input-container {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        .textarea {
            width: 100%;
            min-height: 60px;
            max-height: 200px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            font-family: inherit;
            font-size: 16px;
            overflow-y: auto;
        }
        .button {
            padding: 12px 20px;
            background-color: #0084ff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            align-self: flex-end;
        }
        .button:hover {
            background-color: #0077e6;
        }
        .button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .code-block {
            background-color: #f5f7f9;
            border-radius: 4px;
            padding: 15px;
            overflow-x: auto;
            font-family: 'Courier New', Courier, monospace;
            margin: 15px 0;
            border-left: 4px solid #0084ff;
        }
        .language-selector {
            margin-top: 10px;
        }
        select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 14px;
        }
        .feedback-container {
            display: flex;
            justify-content: flex-end;
            margin-top: 8px;
            gap: 10px;
        }
        .feedback-btn {
            background-color: transparent;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
            opacity: 0.7;
            transition: opacity 0.3s, transform 0.2s;
        }
        .feedback-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }
        .feedback-form {
            margin-top: 10px;
            display: none;
        }
        .feedback-textarea {
            width: 100%;
            min-height: 60px;
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-family: inherit;
        }
        .title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            color: #0084ff;
        }
        .loading {
            align-self: center;
            margin: 20px 0;
            display: none;
        }
        .loading:after {
            content: " ";
            display: block;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 6px solid #0084ff;
            border-color: #0084ff transparent #0084ff transparent;
            animation: loading 1.2s linear infinite;
        }
        @keyframes loading {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="title">LeetCode RAGåŠ©æ‰‹</div>
        <div class="chat-container">
            <div class="sidebar">
                <h3>è¯´æ˜</h3>
                <p>è¿™æ˜¯ä¸€ä¸ªåŸºäºæ£€ç´¢å¢å¼ºç”Ÿæˆ(RAG)çš„LeetCodeè§£é¢˜åŠ©æ‰‹ï¼Œå¯ä»¥ï¼š</p>
                <ul>
                    <li>è§£å†³LeetCodeé—®é¢˜</li>
                    <li>æä¾›è¯¦ç»†çš„æ€è€ƒè¿‡ç¨‹</li>
                    <li>æ”¯æŒå¤šç§ç¼–ç¨‹è¯­è¨€</li>
                </ul>
                <p>æ‚¨çš„åé¦ˆå°†ç”¨äºæ”¹è¿›ç³»ç»Ÿï¼</p>
                
                <h3>ä½¿ç”¨æ–¹æ³•</h3>
                <ol>
                    <li>è¾“å…¥LeetCodeé—®é¢˜</li>
                    <li>é€‰æ‹©ç¼–ç¨‹è¯­è¨€</li>
                    <li>ç­‰å¾…ç”Ÿæˆè§£å†³æ–¹æ¡ˆ</li>
                    <li>æä¾›æ‚¨çš„åé¦ˆ</li>
                </ol>
            </div>
            <div class="chat-area">
                <div id="chat-messages" class="chat-messages">
                    <div class="message assistant-message">
                        æ‚¨å¥½ï¼æˆ‘æ˜¯LeetCode RAGåŠ©æ‰‹ï¼Œè¯·è¾“å…¥æ‚¨æƒ³è§£å†³çš„LeetCodeé—®é¢˜ã€‚
                    </div>
                </div>
                <div id="loading" class="loading"></div>
                <div class="input-area">
                    <div class="input-container">
                        <textarea id="user-input" class="textarea" placeholder="è¾“å…¥LeetCodeé—®é¢˜..."></textarea>
                        <div class="language-selector">
                            <label for="language">ç¼–ç¨‹è¯­è¨€:</label>
                            <select id="language">
                                <option value="python">Python</option>
                                <option value="java">Java</option>
                                <option value="javascript">JavaScript</option>
                                <option value="cpp">C++</option>
                            </select>
                        </div>
                    </div>
                    <button id="send-btn" class="button" onclick="sendMessage()">å‘é€</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentSolutionId = null;
        
        function sendMessage() {
            const userInput = document.getElementById('user-input').value.trim();
            const language = document.getElementById('language').value;
            
            if (!userInput) return;
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage(userInput, true);
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('user-input').value = '';
            
            // æ˜¾ç¤ºåŠ è½½ä¸­
            document.getElementById('loading').style.display = 'block';
            document.getElementById('send-btn').disabled = true;
            
            // å‘é€è¯·æ±‚
            fetch('/api/solve', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    problem: userInput,
                    language: language
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('è¯·æ±‚å¤±è´¥');
                }
                return response.json();
            })
            .then(data => {
                // å­˜å‚¨è§£å†³æ–¹æ¡ˆID
                currentSolutionId = data.solution_id;
                
                // å‡†å¤‡å›å¤å†…å®¹
                let replyContent = formatAssistantReply(data);
                
                // æ·»åŠ åŠ©æ‰‹æ¶ˆæ¯
                addMessage(replyContent, false, data.solution_id);
            })
            .catch(error => {
                console.error('Error:', error);
                addMessage('ç”Ÿæˆè§£å†³æ–¹æ¡ˆæ—¶å‡ºé”™ï¼Œè¯·é‡è¯•ã€‚', false);
            })
            .finally(() => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('send-btn').disabled = false;
            });
        }
        
        function formatAssistantReply(data) {
            // æå–ä»£ç å’Œæ¨ç†è§£é‡Š
            const code = data.code;
            const reasoning = data.reasoning;
            const language = document.getElementById('language').value;
            
            // åˆ›å»ºæ ¼å¼åŒ–åçš„å›å¤
            let formattedReply = '';
            
            // æ·»åŠ æ¨ç†éƒ¨åˆ†ï¼ˆå»é™¤ä»£ç å—ï¼‰
            const reasoningWithoutCode = reasoning.replace(/```.*?```/gs, '');
            formattedReply += reasoningWithoutCode;
            
            // æ·»åŠ ä»£ç å—
            formattedReply += `\n\nä»¥ä¸‹æ˜¯${language}å®ç°:\n\n\`\`\`${language}\n${code}\n\`\`\``;
            
            return formattedReply;
        }
        
        function addMessage(content, isUser, solutionId = null) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = isUser ? 'message user-message' : 'message assistant-message';
            
            // æ ¼å¼åŒ–å†…å®¹ï¼Œå¤„ç†ä»£ç å—å’Œæ¢è¡Œ
            content = formatContent(content);
            messageDiv.innerHTML = content;
            
            // å¦‚æœæ˜¯åŠ©æ‰‹æ¶ˆæ¯ä¸”æœ‰è§£å†³æ–¹æ¡ˆIDï¼Œæ·»åŠ åé¦ˆæŒ‰é’®
            if (!isUser && solutionId) {
                const feedbackContainer = document.createElement('div');
                feedbackContainer.className = 'feedback-container';
                
                // æ·»åŠ "å¥½"æŒ‰é’®
                const goodBtn = document.createElement('button');
                goodBtn.className = 'feedback-btn';
                goodBtn.innerHTML = 'ğŸ‘';
                goodBtn.title = 'è¿™ä¸ªè§£å†³æ–¹æ¡ˆå¾ˆå¥½';
                goodBtn.onclick = () => showFeedbackForm(messageDiv, solutionId, true);
                feedbackContainer.appendChild(goodBtn);
                
                // æ·»åŠ "ä¸å¥½"æŒ‰é’®
                const badBtn = document.createElement('button');
                badBtn.className = 'feedback-btn';
                badBtn.innerHTML = 'ğŸ‘';
                badBtn.title = 'è¿™ä¸ªè§£å†³æ–¹æ¡ˆéœ€è¦æ”¹è¿›';
                badBtn.onclick = () => showFeedbackForm(messageDiv, solutionId, false);
                feedbackContainer.appendChild(badBtn);
                
                messageDiv.appendChild(feedbackContainer);
                
                // åˆ›å»ºéšè—çš„åé¦ˆè¡¨å•
                const feedbackForm = document.createElement('div');
                feedbackForm.className = 'feedback-form';
                feedbackForm.innerHTML = `
                    <textarea class="feedback-textarea" placeholder="è¯·æä¾›æ›´è¯¦ç»†çš„åé¦ˆï¼ˆå¯é€‰ï¼‰..."></textarea>
                    <button class="button" onclick="submitFeedback(this, '${solutionId}')">æäº¤åé¦ˆ</button>
                `;
                messageDiv.appendChild(feedbackForm);
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function formatContent(content) {
            // å¤„ç†ä»£ç å—
            content = content.replace(/```(\w*)\n([\s\S]*?)```/g, function(match, language, code) {
                return `<div class="code-block"><pre><code>${code}</code></pre></div>`;
            });
            
            // å¤„ç†æ¢è¡Œ
            content = content.replace(/\n/g, '<br>');
            
            return content;
        }
        
        function showFeedbackForm(messageDiv, solutionId, isPositive) {
            // è·å–åé¦ˆå®¹å™¨å’Œè¡¨å•
            const feedbackContainer = messageDiv.querySelector('.feedback-container');
            const feedbackForm = messageDiv.querySelector('.feedback-form');
            
            // å­˜å‚¨åé¦ˆç±»å‹
            feedbackForm.dataset.isPositive = isPositive;
            
            // æ˜¾ç¤ºè¡¨å•
            feedbackForm.style.display = 'block';
            
            // æ›´æ–°æŒ‰é’®é¢œè‰²ä»¥æ˜¾ç¤ºé€‰æ‹©
            const goodBtn = feedbackContainer.querySelector('.feedback-btn:first-child');
            const badBtn = feedbackContainer.querySelector('.feedback-btn:last-child');
            
            goodBtn.style.opacity = isPositive ? '1' : '0.5';
            badBtn.style.opacity = isPositive ? '0.5' : '1';
        }
        
        function submitFeedback(button, solutionId) {
            const feedbackForm = button.parentNode;
            const comment = feedbackForm.querySelector('textarea').value;
            const isPositive = feedbackForm.dataset.isPositive === 'true';
            
            // ç¦ç”¨æŒ‰é’®ï¼Œæ˜¾ç¤ºæäº¤ä¸­
            button.disabled = true;
            button.textContent = 'æäº¤ä¸­...';
            
            // å‘é€åé¦ˆè¯·æ±‚
            fetch('/api/feedback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    solution_id: solutionId,
                    is_positive: isPositive,
                    comment: comment
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('è¯·æ±‚å¤±è´¥');
                }
                return response.json();
            })
            .then(data => {
                // éšè—è¡¨å•
                feedbackForm.style.display = 'none';
                
                // æ˜¾ç¤ºæ„Ÿè°¢ä¿¡æ¯
                const thankYou = document.createElement('div');
                thankYou.style.textAlign = 'right';
                thankYou.style.marginTop = '10px';
                thankYou.style.fontSize = '14px';
                thankYou.style.color = '#666';
                thankYou.textContent = 'æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼';
                feedbackForm.parentNode.appendChild(thankYou);
                
                // 3ç§’åç§»é™¤æ„Ÿè°¢ä¿¡æ¯
                setTimeout(() => {
                    thankYou.style.display = 'none';
                }, 3000);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('æäº¤åé¦ˆå¤±è´¥ï¼Œè¯·é‡è¯•');
            })
            .finally(() => {
                // é‡ç½®æŒ‰é’®
                button.disabled = false;
                button.textContent = 'æäº¤åé¦ˆ';
            });
        }
        
        // å…è®¸æŒ‰å›è½¦é”®å‘é€æ¶ˆæ¯
        document.getElementById('user-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
</body>
</html>